# 地図・シミュレーション デザイン（Agent A）

ひなんけいろの**地図表示**と**避難シミュレーション**の画面・コンポーネント・状態の設計。  
`docs/ARCHITECTURE.md` および `shared/types.ts` の型に準拠する。

---

## 1. 画面フロー（住民向け）

- **訓練のやり直しフローは用意しない**。開始前に準備確認し、ワンクリックで開始する。
- **途中で中断できる**。**中断＝理由を問わず、避難ログは残さない**（やっぱりやめた、体調不良、間違えて開始した等、いずれも同じ扱い。ログ送信しない）。この基準を仕様として明文化する。

```
[トップ] → [準備画面] → [ワンクリック開始] → [訓練中] → [ゴールで終了ボタン] → [結果・検証]
                │              │                  │              │
                │              │                  └── 中断 ──────┴→ ログ残さない
                │              │
                └──────────────┴── 開始前: スタート位置・目標地・制限時間を表示し準備確認
```

- **準備画面**: スタート位置（**GPS**）・**避難先の複数候補**・制限時間を表示。候補は**標高・建築物の高さ**から「最も高い位置を取れる避難先」のうち、**ユーザーの運動能力で制限時間内に到達可能なもの**を複数提示し、ユーザーが**自ら1つを選択**する。選択した地点が目標地となり、経路・制限時間を確認したうえで**ワンクリックで開始**。
- **訓練中**: ユーザーは**スマホを見ずに移動**する想定。途中で画面を開いた場合は**タイマーがずっと作動している**（バックグラウンドでも経過時間を正確に計測）。
- **終了**: ゴールに到達したら**ユーザーがボタンを押して終了**。このときスタート地点・ゴール地点で**位置情報を取得し正誤を判定**する。
  - **位置が正しい場合**: 訓練として認定し、避難ログを保存可能。
  - **位置が嘘の場合**（ゴール付近にいない等）: **訓練と認定しない。避難ログは残さない。** その人の運動能力の更新には使ってよい（距離・時間などで運動能力データのみ更新可能）。

---

## 2. 準備画面・訓練中画面のレイアウト

### 2.1 準備画面（開始前）

- スタート位置（現在地 or 手動設定）を表示。
- **避難先候補を複数提示**（標高・建築物の高さから算出した「高い」場所のうち、運動能力的に制限時間内に到達可能なもの）。各候補には有効避難高さ・推定距離・推定所要時間を表示。
- ユーザーが**候補から1つを選択**すると、その地点が目標地になる。
- 選択後、**制限時間**と**経路サマリ**（距離・所要時間）を表示し、「準備できた」の確認のうえ**ワンクリックで開始**。

```
┌─────────────────────────────────────┐
│ スタート: 現在地（GPS）               │
│ 制限時間: 15 分                      │
├─────────────────────────────────────┤
│ 避難先を選んでください（複数候補）   │
│  A: 〇〇 12m  約 1.0km / 約 12 分   │
│  B: △△ビル屋上 15m  約 1.2km / 14分 │
│  C: □□ 10m  約 0.8km / 約 10 分   │  ← いずれか1つを選択
├─────────────────────────────────────┤
│ 選択中: B  経路: 約 1.2 km / 約 14 分│
│      [ 準備できた。訓練を開始 ]       │  ← ワンクリック開始
└─────────────────────────────────────┘
```

### 2.2 訓練中（開始後）

- **歩きながら見る前提はしない**。ユーザーはスマホを見ずに移動する。
- 途中で画面を開いたときに**タイマーが作動している**ことが分かるようにする（経過時間 or 残り時間を表示）。
- **終了ボタン**: GPS でゴール至近にいる場合**のみ**押せる（至近でないときは押せない）。
- **中断ボタン**: **いつでも**押せる。押した場合はログを残さずに終了（理由は問わない。「やっぱりやめた」も含め、中断＝避難ログは残さないと仕様で言語化する）。

```
┌─────────────────────────────────────┐
│ 経過 05:32  残り 09:28  津波到達まで  │  ← 常に正確に動作（バックグラウンドでも）
├─────────────────────────────────────┤
│     [ ゴールに着いた。終了する ]     │  ← ゴール至近でのみ有効（GPS で判定）
│     [ 中断する ]                     │  ← いつでも押せる。ログ残さない
└─────────────────────────────────────┘
```

- タイマーは**実時刻ベース**で計算する（開始日時 `startedAt` を記録し、経過 = now - startedAt）。アプリがバックグラウンドでも経過時間が正しく算出できるようにする。

---

## 3. 終了時の位置検証

- **終了ボタンは、GPS でゴール至近にいる場合のみ押せる**ようにする（至近でないときは無効化または非表示）。
- 押下時に**現在位置（GPS）を取得**し、ゴール（`evacuationTarget`）からの距離を計算。
- **閾値**: とりあえず **50m 固定**。この閾値は将来変更できるように設定化しておく（定数または設定キーで切り替え可能に）。
- 閾値以内なら**有効**、そうでなければ**無効**（位置が嘘とみなす）。
- **有効**: 訓練として認定。`TrainingLogCreate` を組み立てて保存可能。
- **無効**: 訓練とは認定しない。避難ログは保存しない。**運動能力（mobility）の更新には利用してよい**（ログには保存しないが mobility だけ更新で OK）。

判定結果は `TrainingEndValidation`（`shared/types.ts`）で表現する。スタート位置は **GPS** で取得（GPS はネット接続がなくても動作する想定）。

---

## 3.1 時間切れ時の挙動

- **制限時間を過ぎた場合**:
  - その時点の**位置情報は取得して、移動能力（mobility）のログとして残す**。
  - 本人がゴールに向かって避難訓練を続けている可能性があるため、**超過時間の測定は続ける**。ユーザーが**中断**または**終了**を押すまで計測継続。
  - **終了ボタン**は、GPS でゴール至近にいる場合のみ押せる（時間切れ後も同じ。至近で押したら検証し、有効ならログ保存・`evacuatedInTime: false`）。
  - **中断ボタン**はいつでも押せる。
- **UI での伝え方**: 時間切れだったことを**正直に伝え**、ユーザーが悔しがれるようにする。同時に、**適切な避難場所の再選定**を促す。本人にとって避難可能な場所を把握してほしいので、**優しくアドバイス**する（例: 「残念ながら時間切れでした。もう少し近い避難所や、日ごろから行き慣れた場所を選ぶと、いざというとき安心です」）。

---

## 4. 地図レイヤー（シンプル構成）

- レイヤーは**シンプル**に保つ。
- 構成（下 → 上）: ベースマップ → 津波浸水想定 → 経路 → 避難所・現在地 など。

| 順序 | レイヤー | 内容 |
|------|----------|------|
| 1 | ベースマップ | 国土地理院 / OSM タイル |
| 2 | 津波浸水想定 | 想定区域ポリゴン（半透明） |
| 3 | 経路 | スタート→ゴールのポリライン |
| 4 | 避難所・現在地 | マーカー |

- **訓練後の振り返り**: 実際に歩いた（または記録した）避難経路について、**途中で津波に飲み込まれないか**を振り返れるようにする。訓練後に、経路＋浸水想定を表示し、「津波到達時刻時点で経路のどの区間が浸水域に入るか」を確認できるようにする。

---

## 5. 状態管理（SimulationState と status）

- `SimulationState` に **`status`** を追加: `'running' | 'completed' | 'abandoned'`。
  - `running`: 訓練中。
  - `completed`: ユーザーがゴールで「終了」を押した。このあと位置検証を行う。
  - `abandoned`: ユーザーが「中断」を押した。**ログは残さない**。
- 経過時間は **実時刻ベース**（開始日時を保存し、`elapsedSeconds = (now - startedAt) / 1000`）で算出し、バックグラウンドでも正確に動くようにする。

他フィールドの扱いは従来どおり（`scenario`, `startPosition`, `evacuationTarget`, `route`, `elapsedSeconds`）。`completed` は `status === 'completed'` と等価としてよい。

---

## 6. コンポーネント・ディレクトリ構成（Agent A）

```
lib/
├── map/
│   ├── MapContainer.tsx
│   ├── BaseMapLayer.tsx
│   ├── InundationLayer.tsx
│   ├── RouteLayer.tsx
│   ├── ShelterMarkers.tsx
│   ├── CurrentPositionMarker.tsx
│   └── types.ts
│
├── simulation/
│   ├── useSimulationState.ts   # status 含む状態 + 実時刻ベースのタイマー
│   ├── useRoute.ts             # 経路取得（オンライン: OSRM / オフライン: フォールバック）
│   ├── useTrainingEndValidation.ts  # 終了時の位置取得・有効/無効判定
│   └── constants.ts
│
app/
└── (pages)/
    └── training/
        ├── prepare/            # 準備画面（スタート・目標・制限時間表示、ワンクリック開始）
        └── page.tsx            # 訓練中（タイマー、終了/中断ボタン）、または結果・振り返り
```

- **振り返り**: 訓練結果画面で、**実際に記録した軌跡**と浸水想定を重ねて「経路のどこが津波に飲まれるか」を表示するビューを用意する。**軌跡は重要**であり、訓練中は一定間隔で GPS を記録して実際の移動経路を残す。

---

## 7. ルーティング・距離：オフライン優先

- **OSRM 公開 API は最初から利用する**（オンライン時は OSRM で歩行者経路を取得）。
- **有事でオンラインが保証されないため、オフラインでも機能することを優先**する。
  - オフライン時: 地図タイル・浸水想定・避難所データは**キャッシュ**から表示。
  - **避難訓練先（ゴール）の選定**: 直線距離でアバウトに行ってよい（オフライン時も、直線距離で「この建物まで○m」のように推奨ゴールを出せるようにする）。
  - **実際の移動ログ**: 訓練中は **実際の移動距離・移動経路（軌跡）** を収集する。計画経路が直線であっても、**実移動の軌跡（GPS の時系列）とそこから算出した実距離・実所要時間**を記録する。オフライン時も GPS は利用可能なので軌跡は取得する。
- インターフェースは「経路取得: オンラインなら OSRM / オフラインなら直線等でゴール選定」に差し替え可能な形で実装する。

---

## 8. 他エージェントとのインターフェース

- **Agent C（住民UI）**
  - 準備画面でスタート・目標・制限時間を表示し、ワンクリック開始。
  - 訓練中は終了/中断ボタンを提供。終了時は `useTrainingEndValidation` の結果に応じて:
    - **有効**: `TrainingLogCreate` を組み立てて Agent B に送る。
    - **無効**: 避難ログは送らない。運動能力更新用データのみ送る（別 API または同一 API のフラグで区別）。
  - `status === 'abandoned'` のときはログ送信しない。
- **Agent B（API）**
  - 有効な訓練のみ `TrainingLogCreate` として保存。無効時は避難ログを保存しないが、運動能力更新用の受け口は用意する（必要に応じて）。
- **Agent D**
  - 変更なし。集計・GeoJSON は Agent B 経由。

---

## 9. アクセシビリティ・UX メモ

- タイマーは **実時刻ベース** で必ず正確に動かす（バックグラウンド・スリープ時も考慮）。
- 訓練後の振り返りで「経路が津波に飲み込まれるか」を分かりやすく表示する（浸水想定との重なりを強調する等）。

---

---

## 10. 移動能力の初期値・更新・不採用ログ（Agent C/B と連携）

- **初期値**: 個人設定で**年齢・ADL（日常生活動作）**を選択し、**厚生労働省のデータを参照**して予測される移動能力を初期値として設定する。以降は本人のログを元に更新する。
- **訓練時の移動手段**: 訓練開始前に**移動手段を選択**（徒歩・車椅子等）し、その移動手段ごとにログから移動速度を更新する。
- **逸脱時の不採用**: 訓練での移動速度が**明らかに逸脱**している場合、選択した移動手段と実際の移動手段が違う可能性があるとみなし、**その訓練ログは不採用**にする。**本人に通知**する（例: 「今回の移動速度がこれまでの記録と大きく異なります。移動手段を誤って選択していませんか？ この回は訓練ログとして採用していません。運動能力の更新には反映しています」）。
- 不採用にした場合も、**運動能力（mobility）の更新には使ってよい**。避難ログとしては保存しない。

---

このドキュメントは Agent A の実装の基準とする。変更時は `shared/types.ts` と `docs/ARCHITECTURE.md` との整合を保つこと。
