# ひなんけいろ - プロジェクト計画書（設計図）

これまでの壁打ち内容を整理した「設計図」として固定する。目的・機能・技術・構成・エージェント役割を一覧できる。

---

## 1. アプリの目的

| 項目 | 内容 |
|------|------|
| **名称** | ひなんけいろ（津波避難訓練アプリ） |
| **対象地域** | 日本の沿岸部。**当面は静岡県浜松市**の住民避難を中心に展開。将来的に国内沿岸部全地域を想定。 |
| **目的** | **平時に**、実在の建築物・地図を活用した津波避難訓練シミュレーションを行い、住民の運動ログを行政と共有して**科学的な防災設計**に役立てる。あわせて、データ提供の**インセンティブ**と**健康効果**で継続的な訓練参加を促す。 |
| **避難の目標** | 位置情報・標高・建築物の高さと個人の運動能力を組み合わせ、**制限時間内に到達可能な最も高い場所**へ避難するシミュレーションを提供する（津波から身を守れる「有効避難高さ」の最大化）。訓練時には、**運動能力的に避難可能性の高い場所を複数提示**し、**ユーザーが自ら1つを選んで**目標地とする。 |

---

## 2. 主要機能

### 2.1 地図・シミュレーション

- **実地図表示**: 実在の建築物・道路・津波浸水想定を表示（国土地理院タイル・PLATEAU 浜松市など）。
- **避難経路シミュレーション**: 現在地 → 避難先までの経路・所要時間をシミュレート。
- **津波到達時間・浸水想定**: 想定シナリオに基づくタイムリミット表示（カウントダウン・到達円等）。
- **避難先候補の提示**: 標高・建築物の高さから「有効避難高さ」を算出し、制限時間内に到達可能な候補を複数提示。ユーザーが1つを選択して目標地とする。
- **訓練フロー**: 準備画面（スタート・候補選択・ワンクリック開始）→ 訓練中（タイマー・ゴールで終了 or 中断）→ 結果・検証。中断時はログを残さない。詳細は `docs/DESIGN_MAP_SIMULATION.md`。

### 2.2 ログ・データ共有

- **訓練ログ記録**: 経路（GeoJSON）・歩行距離・所要時間・タイムスタンプ・匿名ユーザーID を記録。
- **行政向けエクスポート**: 匿名化・集計されたデータを CSV/GeoJSON で提供。同意済みログのみ。
- **運動能力の推定**: 訓練ログから個人の歩行速度等を算出（`UserMobilityProfile` / `EmergencyGuideProfile`）。有事時のガイドに利用。

### 2.3 行政・科学的デザイン

- **訓練インセンティブ**: 地域・年齢層・性別・期間でターゲットを設定し、振興券等で訓練を促進（行政ダッシュボード側の設定と住民アプリの「あと○回でご褒美」連携）。

### 2.4 住民向けインセンティブ・健康

- **ゲーミフィケーション**: バッジ・ランク・週間/月間達成率・ポイントで継続を促進。
- **健康指標**: 歩数・距離と訓練の紐付け。「今月○km 歩いた」などの可視化。
- **貢献の見える化**: 過去の貢献回数・「あと何回でご褒美」・行政からの感謝メッセージを表示。
- **有事の自分メリット**: 平時の訓練が有事時の「自分に合ったガイド」と「体で覚えた経路」につながることをアプリ内で伝える。

詳細は `docs/DESIGN_RESIDENT_UX.md`。

---

## 3. 技術スタック

| 項目 | 方針 |
|------|------|
| **構成** | モノレポ。Next.js 1本でフロント + API Routes。行政ダッシュボードは `/admin` または別アプリ化も可。 |
| **共通型** | `shared/types.ts` を全エージェントで参照。型の追加・変更はここに集約。 |
| **地図** | 国土地理院タイル + Leaflet または Mapbox GL JS。建築物は PLATEAU 浜松市を GeoJSON 化して静的配置 or API。 |
| **標高** | 国土地理院の標高 API または標高タイル。 |
| **ルーティング** | OSRM（歩行者）または国交省 API 等。 |
| **DB** | SQLite / PostgreSQL + Prisma（訓練ログ保存）。 |
| **認証** | 住民は**匿名IDのみ**。行政は別認証（APIキー or ログイン）。 |
| **デプロイ** | 想定なし。GitHub 上で公開・共有できればOK。必要なら Vercel / GitHub Pages を検討可。 |

詳細は `docs/TECH_STACK.md`。

---

## 4. ディレクトリ構成

```
hinankeiro/
├── shared/                 # 共通型・定数
│   └── types.ts
├── lib/                    # フロント/API 共通ロジック
│   ├── map/                # Agent A: 地図・シミュレーション
│   ├── db/                 # Agent B: DB・ログ
│   ├── gamification/       # Agent C: バッジ・ランク・インセンティブ
│   ├── analytics/          # Agent D: 集計
│   └── ...
├── app/                    # Next.js App Router
│   ├── api/                # API Routes（Agent B 等）
│   ├── admin/              # 行政ダッシュボード（Agent D）
│   └── (住民向けページ)
├── data/                   # 静的な GeoJSON 等（Agent E が生成・配置）
│   └── hamamatsu/          # 浜松市建築物・浸水想定・避難所
├── scripts/                # データ取り込み・ビルド（Agent E）
├── docs/                   # 設計・計画ドキュメント
│   ├── PROJECT_PLAN.md     # 本ファイル（設計図）
│   ├── ARCHITECTURE.md     # アーキテクチャ・ビジョン・データソース
│   ├── TECH_STACK.md       # 技術スタック・環境変数
│   ├── DESIGN_MAP_SIMULATION.md  # 地図・シミュレーション詳細（Agent A）
│   ├── DESIGN_RESIDENT_UX.md      # 住民向けUX・インセンティブ（Agent C）
│   ├── DATA_HAMAMATSU.md   # 浜松市データ戦略
│   ├── ORCHESTRATOR.md     # 統括Agent の役割
│   └── TODO.md             # タスク分解・着手用指示
└── AGENTS.md               # 複数エージェント役割分担（要約）
```

---

## 5. 各 Agent の役割分担（詳細）

### Agent A: 地図・シミュレーション基盤

- **担当**: `lib/map/`（および地図関連コンポーネント）、`lib/simulation/`（があれば）、準備画面・訓練中画面の地図部分。
- **責務**:
  - 地図ライブラリの選定・初期化（Leaflet / Mapbox、国土地理院タイル）。
  - 津波浸水想定レイヤー・避難所ピン・建築物オーバーレイ（高さ付き）の表示。
  - 「現在地 → 避難先」の経路描画（ルーティング API またはクライアント側経路）。
  - 津波到達時間を考慮したタイムリミットの可視化（カウントダウン・到達円等）。
  - 制限時間内の到達可能範囲の計算と、その範囲内で有効避難高さが高い候補の算出・表示。
  - 準備画面: スタート位置（GPS）・避難先複数候補・制限時間表示。ユーザーが1つ選択 → ワンクリック開始。
  - 訓練中: タイマー（実時刻ベース、バックグラウンドでも正確）、ゴール至近でのみ終了ボタン有効、中断ボタンはいつでも（ログ残さない）。
  - 終了時の位置検証: ゴールから 50m 以内かどうかで訓練認定の有無を判定。仕様は `docs/DESIGN_MAP_SIMULATION.md` に準拠。
- **成果物**: 地図コンポーネント、シミュレーション状態管理、`SimulationState`, `RouteResult`, `EvacuationScenario`, `EvacuationOptionForChoice` 等の型利用・必要なら `shared/types.ts` に追加提案。
- **参照**: `docs/DESIGN_MAP_SIMULATION.md`, `docs/DATA_HAMAMATSU.md`, `docs/ARCHITECTURE.md`.

---

### Agent B: 訓練ログ・API・バックエンド

- **担当**: `app/api/`, `lib/db/`, `lib/logs/`（があれば）。
- **責務**:
  - 訓練ログのスキーマ設計（経路 GeoJSON、所要時間、距離、userId、匿名ID、同意フラグ等）。Prisma 等で実装。
  - POST /api/training-logs（ログ保存）、GET /api/training-logs（取得、userId・期間・scenarioId 等でフィルタ）。
  - GET /api/training-logs/export（行政向けエクスポート。同意済みのみ、期間・format=csv|geojson）。
  - 認証・認可: 住民は匿名ID、行政向けエクスポートは API キー or ログイン要検討。
  - 運動能力プロファイル: 訓練ログから `UserMobilityProfile` / `EmergencyGuideProfile` を算出するロジック（必要に応じて）。
- **成果物**: REST エンドポイント、DB マイグレーション、`TrainingLog`, `TrainingLogCreate`, `ExportOptions` の実装との整合。
- **参照**: `shared/types.ts`, `docs/ARCHITECTURE.md`, `README.md` の API 説明。

---

### Agent C: 住民向け UI・インセンティブ・健康

- **担当**: `app/` の住民向け画面（地図以外）、`lib/gamification/`, `lib/health/`（があれば）。トップ・準備・訓練中・結果・履歴・設定・同意フロー等。
- **責務**:
  - トップ画面・訓練開始/終了フロー・履歴一覧。大きなタップ領域・読みやすいフォント・アクセシビリティ（`docs/DESIGN_RESIDENT_UX.md` 方針）。
  - ゲーミフィケーション: バッジ、ランク、週間/月間達成率、ポイント。地域ポイント（あと○回でご褒美）・行政の感謝メッセージ表示。
  - 健康指標: 歩数・距離の表示、訓練と連携した「歩いた距離」の可視化。
  - 行政へのデータ提供同意フロー・説明文。拒否しても訓練は可能、自分用記録は残る。
  - 有事モード: 有事ボタンで切り替え。デフォルトは平時。
- **成果物**: 画面コンポーネント、バッジ/ランク定義、同意モーダル、`UserProfile`, `Badge`, `ConsentStatus`, `UserContributionSummary` 等の利用・必要なら型追加提案。
- **参照**: `docs/DESIGN_RESIDENT_UX.md`, `docs/ARCHITECTURE.md`, `shared/types.ts`.

---

### Agent D: 行政向けダッシュボード・可視化

- **担当**: `app/admin/`（または `dashboard/`）, `lib/analytics/`。
- **責務**:
  - 行政担当者用ログイン（または API キーによるエクスポートのみ）。
  - 集計ダッシュボード: 地域別・期間別の訓練回数、経路のヒートマップ、平均所要時間、避難成功率等。
  - データエクスポート画面: CSV/GeoJSON ダウンロード（GET /api/training-logs/export の呼び出し）。
  - 防災設計に役立つ指標: 避難所までの平均時間、遅い経路の検出、ボトルネック候補。インセンティブキャンペーン設定（地域・期間・ターゲット・ご褒美条件）は将来拡張。
- **成果物**: ダッシュボードページ、グラフ・地図の可視化、`AggregatedStats`, `ExportFormat` の利用。
- **参照**: `docs/ARCHITECTURE.md`, `shared/types.ts`, Agent B の API 仕様。

---

### Agent E: インフラ・CI・データ取り込み

- **担当**: `scripts/`, `data/`, `.github/`（CI）、設定ファイル、`.env.example`。
- **責務**:
  - 津波浸水想定・避難所データの取得スクリプト（国・自治体オープンデータ）。GeoJSON 化して `data/` に配置。
  - 建築物データ: Project PLATEAU 浜松市の取得・変換（建物ポリゴン + 高さ）。`data/hamamatsu/buildings.geojson` 等。`docs/DATA_HAMAMATSU.md` に従う。
  - 標高は国土地理院 API/タイルで取得する方針のため、静的ファイルはオプション。必要なら取得スクリプトの整備。
  - CI: lint / test / build。デプロイは GitHub 公開を前提、必要なら Vercel / GitHub Pages 手順。
  - 環境変数・シークレットのドキュメント（.env.example と README の環境構築）。
- **成果物**: データパイプライン、`data/README.md`, `scripts/README.md` の更新、CI 設定。
- **参照**: `docs/DATA_HAMAMATSU.md`, `docs/TECH_STACK.md`, `docs/ARCHITECTURE.md`.

---

## 6. 並行開発のルール

1. **型・API は `shared/types.ts` に集約**。各エージェントはここに定義し、他は import して使う。
2. **担当外のディレクトリはインターフェースを壊さない**。他担当の型・API を尊重する。
3. **インターフェースを先に決める**。例: 訓練ログ保存 API のリクエスト/レスポンスを `shared/types.ts` で決めてから、Agent B が実装、A/C が呼び出す。
4. **大きな仕様変更は `docs/ARCHITECTURE.md` または本ファイルに追記**し、全エージェントで認識を揃える。

---

## 7. 関連ドキュメント一覧

| ファイル | 内容 |
|----------|------|
| `docs/ARCHITECTURE.md` | ビジョン・システム構成・データソース・非機能要件・有事時方針 |
| `docs/TECH_STACK.md` | 技術スタック・ディレクトリ・環境変数 |
| `docs/DESIGN_MAP_SIMULATION.md` | 地図・シミュレーションの画面フロー・終了判定・レイヤー・コンポーネント（Agent A） |
| `docs/DESIGN_RESIDENT_UX.md` | 住民向けUX・インセンティブ・貢献の見える化・アクセシビリティ（Agent C） |
| `docs/DATA_HAMAMATSU.md` | 浜松市向けデータ戦略・PLATEAU・標高・有効避難高さ（Agent A / E） |
| `docs/ORCHESTRATOR.md` | 統括Agent の役割と運用 |
| `docs/TODO.md` | タスク分解・今日着手するタスク・他 Agent 用指示文 |
| `AGENTS.md` | エージェント役割の要約・並行開発ルール |

この設計図をベースに、統括Agent がタスクを分解し、各専門 Agent へ指示を出して開発を進める。
